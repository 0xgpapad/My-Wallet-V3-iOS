<html>
<head>
    
<style type="text/css">
body {
    word-wrap: break-word;
    -webkit-text-size-adjust:none;
    font-family:Helvetica, Arial, Verdana, sans-serif;
    padding:5px;
}
</style>
        
<script type="text/javascript"> 
try {
    ${jquery}
    ${bootstrap}

    ${bitcoinjs}
    ${shared}
    ${blockchainapi}
    ${signer}
    ${wallet}
    ${bridge}
    
    var MyWalletPhone = {};

    console.log = function(message) {
        device.execute("log:", message);
    }

    isExtension = true;
    APP_NAME = 'javascript_iphone_app';
    APP_VERSION = '0.1 BETA';
    root = "https://blockchain.info/";
    
    $(document).ready(function() {
        MyWallet.logout = function() {}
    });
  
    MyWallet.addEventListener(function (event) {
        device.execute(event);
    });
    
    MyWalletPhone.generateNewKey = function() {
        var key = MyWallet.generateNewKey();
        
        if (!key) return;
        
        var address = key.getBitcoinAddress().toString();
        
        return key.concat("|").concat(address);
    }
    
    MyWalletPhone.getMultiAddrResponse = function() {
        var obj = {};
        
        obj.transactions = MyWallet.getTransactions();
        obj.total_received = MyWallet.getTotalReceived();
        obj.total_sent = MyWallet.getTotalSent();
        obj.final_balance = MyWallet.getFinalBalance();
        obj.n_transactions = obj.transactions.length;

        return obj;
    }
    
    MyWalletPhone.addPrivateKey = function(privateKeyString) {
        try {
            var format = MyWallet.detectPrivateKeyFormat(privateKeyString);

            if (format == 'bip38') {
                throw 'Unsupported';
            }

            var key = MyWallet.privateKeyStringToKey(privateKeyString, format);

            var addr = null;
            if (format == 'compsipa') {
                addr = key.getBitcoinAddressCompressed().toString();
            } else {
                addr = key.getBitcoinAddress().toString();
            }

            if (addr == null || addr.length == 0 || addr == 'undefined')
                throw 'Unable to decode bitcoin addresses from private key';

            if (MyWallet.addressExists(addr) && !MyWallet.isWatchOnly(addr))
                throw 'Address already exists in the wallet';
                
            return MyWallet.addPrivateKey(key, {compressed : format == 'compsipa', app_name : APP_NAME, app_version : APP_VERSION});
        } catch (e) {
            console.log(e);
            return false;
        }
    }

    MyStore.put = function (key, value) {
        device.execute("saveKey:", key, value);
    }

    MyStore.get = function (key, callback) {
        var callback_obj = device.execute("getKey:", key, value);
        
        callback_obj.response = callback;
    }
    
    MyStore.remove = function(key) {
        device.execute("removeKey:", key);
    }
    
    MyStore.clear = function() {
        device.execute("clearKeys:");
    }
    
    var listener = {
        on_error : function (e) {
            console.log('on_error');
        },
        on_success : function () {
            console.log('on_success');
        },
        on_start : function () {
            console.log('on_start');
        }
    };

    MyWallet.parsePairingCode = function (raw_code) {
        
        var success = function (pairing_code) {
            device.execute("didParsePairingCode:", pairing_code);
        }
        
        var error = function (message) {
            device.execute("errorParsingPairingCode:", message);
        }
        
        try {
            if (raw_code == null || raw_code.length == 0) {
                throw "Invalid Pairing QR Code";
            }
            
            if (raw_code[0] != '1') {
                throw "Invalid Pairing Version Code " + raw_code[0];
            }
            
            var components = raw_code.split("|");
            
            if (components.length < 3) {
                throw "Invalid Pairing QR Code. Not enough components.";
            }
            
            var guid = components[1];
            if (guid.length != 36) {
                throw "Invalid Pairing QR Code. GUID wrong length.";
            }
            
            var encrypted_data = components[2];
            
            $.ajax({
                   type: "POST",
                   url: root + 'wallet',
                   data: {
                       format: 'plain',
                       method: 'pairing-encryption-password',
                       guid: guid
                   },
                   success: function (encryption_phrase) {
                           var decrypted = MyWallet.decrypt(encrypted_data, encryption_phrase, MyWallet.getDefaultPbkdf2Iterations(), function (decrypted) {
                                         return decrypted != null;
                                  }, function () {
                                         error('Decryption Error');
                               });
                           
                           if (decrypted != null) {
                           var components2 = decrypted.split("|");
                           
                           success({
                                   version: raw_code[0],
                                   guid: guid,
                                   sharedKey: components2[0],
                                   password: UTF8.bytesToString(Crypto.util.hexToBytes(components2[1]))
                                });
                           }
                       },
                   error: function (res) {
                            error(res.responseText);
                   }
                   });
        } catch (e) {
            error('Error ' + e);
        }
    }
    
    function setPassword(password) {
        console.log('Set Password ' + password);
        
        $('#restore-password').val(password);
        
        $('#restore-wallet-continue').click();
    }

    function parseAddress(addrstring) {
        try {
            return new Bitcoin.Address(addrstring).toString();
        } catch (e) {
            return null;
        }
    }
} catch (e) {
    console.log(e);
}
</script>

<meta name="viewport" content="width=150px, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

</head>

<body>
    <input type="text" id="restore-password">
    <input type="text" id="restore-guid">
    <input type="submit" id="restore-wallet-continue">
</body>
</html>