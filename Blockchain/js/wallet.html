<html>
<head>
    
<style type="text/css">
body {
    word-wrap: break-word;
    -webkit-text-size-adjust:none;
    font-family:Helvetica, Arial, Verdana, sans-serif;
    padding:5px;
}
</style>
        
<script type="text/javascript"> 
try {
    ${jquery}
    ${bootstrap}

    ${bitcoinjs}
    ${shared}
    ${blockchainapi}
    ${signer}
    ${wallet}
    ${bridge}

    console.log = function(message) {
        device.execute("log:", message);
    }

    isExtension = true;
    APP_NAME = 'javascript_iphone_app';
    root = "https://blockchain.info/";
    
    $(document).ready(function() {
        MyWallet.logout = function() {}
    });
  
    MyWallet.addEventListener(function (event) {
        device.execute(event);
    });
    
    function exceptionToString(err) {
        var vDebug = "";
        for (var prop in err) {
            vDebug += "property: " + prop + " value: [" + err[prop] + "] - ";
        }
        return "Exception: " + vDebug + " toString(): value: [" + err.toString() + "]";
    }

    MyStore.put = function (key, value) {}

    MyStore.get = function (key, callback) {
        callback()
    }

    MyWallet.parsePairingCode = function (raw_code) {
        
        var success = function (pairing_code) {
            device.execute("didParsePairingCode:", pairing_code);
        }
        
        var error = function (message) {
            device.execute("errorParsingPairingCode:", message);
        }
        
        try {
            if (raw_code == null || raw_code.length == 0) {
                throw "Invalid Pairing QR Code";
            }
            
            if (raw_code[0] != '1') {
                throw "Invalid Pairing Version Code " + raw_code[0];
            }
            
            var components = raw_code.split("|");
            
            if (components.length < 3) {
                throw "Invalid Pairing QR Code. Not enough components.";
            }
            
            var guid = components[1];
            if (guid.length != 36) {
                throw "Invalid Pairing QR Code. GUID wrong length.";
            }
            
            var encrypted_data = components[2];
            
            $.ajax({
                   type: "POST",
                   url: root + 'wallet',
                   data: {
                       format: 'plain',
                       method: 'pairing-encryption-password',
                       guid: guid
                   },
                   success: function (encryption_phrase) {
                       var decrypted = MyWallet.decrypt(encrypted_data, encryption_phrase, MyWallet.getDefaultPbkdf2Iterations(), function (decrypted) {
                                                        return decrypted != null;
                                                        }, function () {
                                                        error('Decryption Error');
                                                        });
                       
                       if (decrypted != null) {
                       var components2 = decrypted.split("|");
                       
                       success({
                               version: raw_code[0],
                               guid: guid,
                               sharedKey: components2[0],
                               password: UTF8.bytesToString(Crypto.util.hexToBytes(components2[1]))
                               });
                       }
                   },
                   error: function (res) {
                    error(res.responseText);
                   }
                   });
        } catch (e) {
            error('Error ' + e);
        }
    }

    function parseAddress(addrstring) {
        try {
            return new Bitcoin.Address(addrstring).toString();
        } catch (e) {
            return null;
        }
    }


    function parseMiniKey(miniKey) {
        var check = Crypto.SHA256(miniKey + '?');
        
        switch (check.slice(0, 2)) {
            case '00':
            var decodedKey = Crypto.SHA256(miniKey, {
                                           asBytes: true
                                           });
                                           return decodedKey;
                                           break;
                                           case '01':
                                           var x = Crypto.util.hexToBytes(check.slice(2, 4))[0];
                                           var count = Math.round(Math.pow(2, (x / 4)));
                                           var decodedKey = Crypto.PBKDF2(miniKey, 'Satoshi Nakamoto', 32, {
                                                                          iterations: count,
                                                                          asBytes: true
                                                                          });
                                                                          return decodedKey;
                                                                          break;
                                                                          default:
                                                                          console.log('invalid key');
                                                                          break;
        }
    };

    //Changed padding to CBC iso10126 9th March 2012 & iterations to pbkdf2_iterations
    function encrypt(data, password) {
        return MyWallet.encryptWallet(data, password);
    }

    //When the ecryption format changes it can produce data which appears to decrypt fine but actually didn't
    //So we call success(data) and if it returns true the data was formatted correctly
    function decrypt(data, password) {
        return MyWallet.decryptWallet(data, password, function (wallet_obj) {
             device.execute("didDecryptWallet:", wallet_obj);
          }, function (message) {
             device.execute("didFailToDecryptWallet:", message);
        });
    }

} catch (e) {
    console.log(e);
}
</script>

<meta name="viewport" content="width=150px, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

</head>

<body>
    <p id="summary" align="center" style="font-size:12px;color:#808080;text-align:center;width:100%"></p>
	<h2 id="status" align="center" style="margin:10px">
		Loading...
	</h2>
		
	<p align="center">
		<button class="btn primary" id="submit-button">Send Payment</button>
	</p>
</body>
</html>